name: model-merger
image: whatcanyousee/verl:ngc-cu124-vllm0.8.3-sglang0.4.5-mcore0.12.0-te2.2
integrations:
  - integration_type: git_repo
    git_repo: orby-ai-engineering/verl
    git_branch: mpk/hsmv2_data_training
    pip_install: .
    ssh_clone: true
command: |
  cd /workspace/verl
  sed -i 's|mirrors.tuna.tsinghua.edu.cn|archive.ubuntu.com|g' /etc/apt/sources.list
  apt update
  apt install iproute2 -y
  apt install -y dnsutils
  apt install -y emacs
  apt install -y awscli
  pip install 'urllib3<2'
  pip install s3fs
  pip install boto3

  mkdir ~/checkpoints
  aws s3 cp --recursive s3://orby-osu-va/subtask/hsmv2_distill/checkpoints/9k_bbox/hsmv2_distill_grpo_9k_qwen32b_batchsize_32_epoch_1_reward_bbox_run2/global_step_248/actor ~/checkpoints/actor

  if [ "$NODE_RANK" = "0" ]; then
    python3 orby/scripts/model_merger.py merge \
      --backend fsdp \
      --hf_model_path Qwen/Qwen2.5-VL-32B-Instruct \
      --local_dir ~/checkpoints/actor \
      --target_dir ~/checkpoints/hf
  fi

  aws s3 cp --recursive ~/checkpoints/hf s3://orby-osu-va/subtask/hsmv2_distill/checkpoints/9k_bbox/hsmv2_distill_grpo_9k_qwen32b_batchsize_32_epoch_1_reward_bbox_run2/global_step_248/hf/
  aws s3 cp s3://orby-osu-va/subtask/hsmv2_distill/datasets/9k_bbox/test.parquet ~/data/test.parquet

  MODEL_PATH=~/checkpoints/hf
  DATA_PATH=~/data/test.parquet

  REWARD_FILE=orby/reward/subtask.py
  REWARD_FN=eval_reward_func
  COORDINATES_METRIC="bbox"
  COORDINATES_GAUSSIAN_SIGMA=5
  COORDINATES_PIXEL_SQUARE_SIZE=10
  OUTPUT_FILE=~/responses/test.parquet

  # Generation
  python3 -m orby.trainer.main_generation \
     trainer.nnodes=1 \
     trainer.n_gpus_per_node=8 \
     data.path=$DATA_PATH \
     data.prompt_key=prompt \
     data.batch_size=512 \
     +data.max_prompt_length=7680 \
     data.n_samples=1 \
     data.output_path=$OUTPUT_FILE \
     model.path=$MODEL_PATH \
     rollout.temperature=0 \
     rollout.top_p=1.0 \
     rollout.prompt_length=7680 \
     rollout.response_length=512 \
     rollout.tensor_model_parallel_size=4 \
     rollout.gpu_memory_utilization=0.7 \
     rollout.max_num_batched_tokens=65536 \
     +rollout.limit_images=3

  # Evaluation
  python3 -m orby.trainer.main_eval \
      data.path=$OUTPUT_FILE \
      data.prompt_key=prompt \
      data.response_key=responses \
      custom_reward_function.path=$REWARD_FILE \
      custom_reward_function.name=$REWARD_FN \
      +custom_reward_function.reward_kwargs.coordinates_metric=$COORDINATES_METRIC \
      +custom_reward_function.reward_kwargs.coordinates_gaussian_sigma=$COORDINATES_GAUSSIAN_SIGMA \
      +custom_reward_function.reward_kwargs.coordinates_pixel_square_size=$COORDINATES_PIXEL_SQUARE_SIZE

compute:
  gpus: 8 # Number of GPUs to use
  cluster: r8z13p2
  gpu_type: h100_80gb
